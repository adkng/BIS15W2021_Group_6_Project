---
title: "Esha_exploration"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

Uploading the data:

```{r}
library(tidyverse)
library(RColorBrewer)
library(paletteer)
library(janitor)
library(here)
library(skimr)
library(ggthemes)
library(naniar)
library(readr)
library(shiny)
library(shinydashboard)
library(stringr)
```

```{r}
nectar_perflower <- read_csv(here("potential_datasets", "AgriLand_Nectar_perflower.csv"))
```

```{r}
nectar_perflower <- janitor::clean_names(nectar_perflower)
```

```{r}
nectar_perflower
```

```{r}
nectar_perflower %>% 
  separate(species,
           into = c("genus", "species")) %>% 
  separate(bagging_date,
           into = c("bagging_day", "bagging_month", "bagging_year"),
           sep = "/")
```

## Analyses: which habitats have the least and most amount of nectar per flower

Exploration of the data: 

Habitats with the most nectar (using sugar_in_micrograms_flower_24h):
```{r}
nectar_perflower %>%
  group_by(habitat) %>%
  filter(sugar_in_micrograms_flower_24h != "NA") %>%
  summarize(mean_nectar = mean(sugar_in_micrograms_flower_24h)) %>%
  arrange(desc(mean_nectar))
```

Habitats with the least nectar: 
```{r}
nectar_perflower %>%
  group_by(habitat) %>%
  filter(sugar_in_micrograms_flower_24h != "NA") %>%
  summarize(mean_nectar = mean(sugar_in_micrograms_flower_24h)) %>%
  arrange(mean_nectar)
```

Plotting the habitats with the most nectar: 
```{r}
nectar_perflower %>%
  group_by(habitat) %>%
  filter(sugar_in_micrograms_flower_24h != "NA") %>%
  summarize(mean_nectar = mean(sugar_in_micrograms_flower_24h)) %>%
  arrange(desc(mean_nectar)) %>%
  top_n(5) %>%
  ggplot(aes(x = habitat, y = mean_nectar, fill = habitat)) + 
  geom_col() + 
  coord_flip() +
  theme_linedraw()
```

Habitats with the most nectar (using sugarmax_in_micrograms_flower_24h instead):
```{r}
nectar_perflower %>%
  group_by(habitat) %>%
  filter(sugarmax_in_micrograms_flower_24h != "NA") %>%
  summarize(mean_nectar_from_max = mean(sugarmax_in_micrograms_flower_24h)) %>%
  arrange(desc(mean_nectar_from_max))
```

```{r}
nectar_perflower %>%
  group_by(habitat) %>%
  filter(sugarmax_in_micrograms_flower_24h != "NA") %>%
  summarize(mean_nectar_from_max = mean(sugarmax_in_micrograms_flower_24h)) %>%
  arrange(mean_nectar_from_max)
```

Plotting the habitats with the most nectar (using sugarmax instead): 
```{r}
nectar_perflower %>%
  group_by(habitat) %>%
  filter(sugarmax_in_micrograms_flower_24h != "NA") %>%
  summarize(mean_nectar_from_max = mean(sugarmax_in_micrograms_flower_24h)) %>%
  arrange(desc(mean_nectar_from_max)) %>%
  top_n(5) %>%
  ggplot(aes(x = habitat, y = mean_nectar_from_max, fill = habitat)) + 
  geom_col() + 
  coord_flip() +
  theme_linedraw()
```

I'm still playing with this plot. My goal is to make one that includes the temporal aspect of this data:
```{r}
nectar_perflower %>%
  group_by(habitat, year) %>%
  filter(sugarmax_in_micrograms_flower_24h != "NA") %>%
  ggplot(aes(x = year, y = sugar_in_micrograms_flower_24h, color = habitat)) + 
  geom_point() +
  theme_linedraw()
```

I'm gonna keep playing with this: 
```{r}
nectar_perflower %>%
  group_by(habitat, year) %>%
  filter(sugar_in_micrograms_flower_24h != "NA") %>%
  filter(habitat == "street" | habitat == "pond" | habitat == "managed grassland-garden" | habitat == "hedgerow" | habitat == "healthland-mooseland") %>%
  summarize(mean_nectar = mean(sugar_in_micrograms_flower_24h)) %>%
  ggplot(aes(x = habitat, y = mean_nectar, fill = habitat)) + 
  geom_col() + 
  coord_flip() +
  facet_wrap(~year) +
  theme_linedraw()
```
Yikes! This is very problematic! We have no way of seeing how nectar collected varies over the years. 

```{r}
nectar_perflower %>%
  group_by(habitat) %>%
  filter(sugar_in_micrograms_flower_24h != "NA") %>%
  filter(year == "2011")
```

```{r}
nectar_perflower %>%
  group_by(habitat) %>%
  filter(sugar_in_micrograms_flower_24h != "NA") %>%
  filter(year == "2012")
```

```{r}
nectar_perflower %>%
  filter(habitat == "wetland") %>%
  filter(sugar_in_micrograms_flower_24h != "NA") %>%
  ggplot(aes(x = habitat, y = sugar_in_micrograms_flower_24h, fill = habitat)) + 
  geom_col() + 
  facet_wrap(~year) +
  theme_linedraw()
```

```{r}
nectar_perflower %>%
  filter(habitat == "wetland") %>%
  filter(sugar_in_micrograms_flower_24h != "NA") %>%
  ggplot(aes(x = year, y = sugar_in_micrograms_flower_24h, fill = habitat)) + 
  geom_point() + 
  geom_line() + 
  theme_linedraw()
```

I made an app to illustrate the point that there are numerous discrepancies in this data:
```{r}
ui <- dashboardPage(
  dashboardHeader(title = "Nectar Collection by Habitat"),
  dashboardSidebar(disable = T),
  dashboardBody(
  fluidRow(
  box(title = "Plot Options", width = 3,
  selectInput("x", "Select a habitat:", choices = c("allotments", "bog", "cemetery-park", "coastland-grassland", "cultivated farmland", "dwarf shrub heath", "garden", "grassland", "grassland-carpark", "grassland-coastland", "grassland-coastland", "grassland-hedgerow", "grassland-nature reserve", "grassland-park", "grassland-wetland", "grassland-woodland", "heathland", "heathland-mooseland", "hedgerow", "hedgerow-woodland", "managed grassland-park", "moorland", "pavement", "pond", "pot", "rock", "street", "wetland", "woodland", "woodland-carpark", "woodland-nature reserve"),
              selected = "wetland"), 
  selectInput("y", "Select an year:", choices = c("2011", "2012"),
              selected = "2011"),
   sliderInput("pointsize", "Select the Point Size", min = 1, max = 5, value = 2, step = 0.5)
  ), 
  box(title = "Nectar Collection by Habitat", width = 7,
  plotOutput("plot", width = "600px", height = "500px")
  ) 
  ) 
  ) 
) 

server <- function(input, output, session) { 
  output$plot <- renderPlot({ 
  nectar_perflower %>%
  filter(habitat==input$x & year ==input$y) %>% 
  ggplot(aes(x = species, y = sugar_in_micrograms_flower_24h, fill = species)) + geom_point(size=input$pointsize, alpha=0.8) + geom_col() + theme_light(base_size = 18)+ theme(axis.text.x = element_text(angle = 60, hjust= 1))+ labs(x = "Species", y = "Nectar Collected (micrograms)")
  })
  session$onSessionEnded(stopApp)
}

shinyApp(ui, server)
```
